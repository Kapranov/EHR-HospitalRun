$('#modal-message-new').html('<%= escape_javascript(render 'new_message_to_practice_form') %>');

initPickers('#modal-message-new');
initSelect2('#modal-message-new');

$('#modal-message-new').modal('show');

var smc = new SubjectMenuController();
smc.initialize('#modal-message-new');

SearchController = function() {
  var input, input_id, button, placeholder, link;

  this.initialize = function(_input, _input_id, _button, _placeholder, _link) {
    input = $(_input)
    input_id = $(_input_id);
    button = $(_button);
    placeholder = _placeholder;
    link = _link;
    
    input.select2({
      width: '100%',
      placeholder: placeholder,
      ajax: {
        url: link,
        processResults: processResults,
        data: function (params) {
          return {
            part: params.term
          };
        },
        cache: true
      },
      escapeMarkup: function (markup) { return markup; },
      minimumInputLength: 1,
      templateResult: templateResult,
      templateSelection: templateSelection
    });

    button.click(function(e) {
      input.select2('open');
    });
  }

  function processResults(data, params) {
    return {
      results: data
    };
  }

  function templateResult(item) {
    if (item.loading) return item.text;
    return '<span>'+item.full_name+'</span>';
  }

  function templateSelection(item) {
    if(item.full_name) {
      input_id.val(item['id']).trigger('change');
      return item.full_name;
    }
    else
      return item.text;
  }
};

var findPracticeStaffController = new SearchController();
findPracticeStaffController.initialize(
  '#modal-message-new #find_message_practice_staff',
  '#modal-message-new #to_id',
  '#modal-message-new #find_message_practice_staff_button',
  'Search Practice Staff',
  '<%= Rails.application.routes.url_helpers.patient_practices_email_messages_path %>'
);